import os
import folium
from dotenv import load_dotenv
from lib.mapbox import MapBoxApi, IsochroneProfile
from lib.geometry import Geometry


load_dotenv()
KAIT_GEO = Geometry(type="", long=139.3399782, lat=35.4861002)


def main():
    # Mapbox apiの準備
    mapbox = MapBoxApi(os.environ["MAPBOX_API_TOKEN"])
    # 神工大から徒歩10,20,30分のエリアのポリゴンを取得
    result = mapbox.get_isochrone(
        prof=IsochroneProfile.Walking,
        geo=KAIT_GEO,
        contours_minutes=[10, 20, 30],
    )
    # isochrone_geojson = result
    isochrone_geojson = {'features': [{'properties': {'fill-opacity': 0.33, 'fillColor': '#bf4040', 'opacity': 0.33, 'fill': '#bf4040', 'fillOpacity': 0.33, 'color': '#bf4040', 'contour': 30, 'metric': 'time'}, 'geometry': {'coordinates': [[[139.347978, 35.50414], [139.346978, 35.504876], [139.345978, 35.504252], [139.343978, 35.504469], [139.342978, 35.503447], [139.340816, 35.503262], [139.338132, 35.501946], [139.337569, 35.502691], [139.335888, 35.50301], [139.333978, 35.504356], [139.330978, 35.504373], [139.330751, 35.5041], [139.331978, 35.503755], [139.332487, 35.5031], [139.3324, 35.501679], [139.331399, 35.5011], [139.332475, 35.499597], [139.332978, 35.499349], [139.333849, 35.500229], [139.335048, 35.50017], [139.335065, 35.4981], [139.334177, 35.497901], [139.334045, 35.497033], [139.332194, 35.496885], [139.330931, 35.496148], [139.330978, 35.494952], [139.325978, 35.494819], [139.322978, 35.49594], [139.321978, 35.495904], [139.320052, 35.495026], [139.320007, 35.494071], [139.319, 35.4931], [139.318589, 35.4891], [139.319258, 35.4881], [139.318465, 35.4871], [139.319078, 35.4852], [139.319978, 35.485366], [139.320316, 35.484438], [139.321138, 35.4841], [139.319978, 35.484078], [139.318492, 35.4831], [139.318664, 35.481786], [139.319978, 35.481655], [139.320978, 35.48075], [139.321978, 35.48144], [139.322161, 35.480283], [139.322978, 35.479731], [139.324867, 35.481211], [139.326978, 35.481398], [139.327163, 35.480285], [139.328033, 35.480155], [139.328136, 35.479258], [139.329028, 35.47915], [139.329138, 35.47826], [139.330978, 35.478181], [139.331121, 35.477243], [139.331978, 35.477172], [139.332835, 35.477243], [139.333018, 35.47814], [139.333146, 35.476268], [139.334027, 35.476149], [139.334119, 35.475241], [139.335026, 35.475148], [139.335075, 35.474004], [139.33137, 35.4721], [139.331978, 35.471453], [139.334105, 35.471227], [139.333357, 35.4701], [139.333863, 35.4681], [139.33528, 35.4681], [139.335731, 35.465853], [139.336978, 35.464279], [139.340978, 35.464891], [139.342978, 35.464564], [139.343978, 35.465207], [139.344978, 35.464607], [139.345978, 35.464776], [139.347978, 35.466262], [139.348978, 35.465436], [139.349978, 35.466237], [139.350978, 35.465666], [139.352709, 35.46637], [139.353236, 35.466843], [139.353324, 35.4681], [139.355552, 35.4711], [139.35573, 35.472348], [139.357185, 35.4731], [139.356976, 35.4741], [139.358499, 35.47458], [139.361405, 35.4771], [139.360696, 35.477818], [139.360565, 35.480687], [139.359865, 35.480987], [139.359683, 35.481805], [139.358891, 35.482013], [139.358739, 35.482861], [139.357907, 35.483029], [139.357778, 35.4841], [139.360062, 35.484184], [139.359762, 35.482884], [139.360978, 35.482578], [139.361611, 35.483467], [139.361492, 35.485586], [139.36271, 35.4861], [139.358978, 35.486481], [139.357978, 35.4856], [139.356978, 35.485727], [139.355978, 35.485005], [139.354978, 35.48502], [139.35482, 35.485942], [139.352925, 35.486047], [139.352691, 35.486813], [139.351866, 35.4871], [139.351753, 35.487876], [139.350919, 35.488041], [139.350799, 35.489921], [139.349906, 35.4901], [139.349978, 35.491561], [139.350978, 35.491043], [139.354978, 35.495068], [139.35508, 35.4981], [139.354295, 35.498417], [139.354079, 35.499201], [139.352484, 35.500606], [139.352056, 35.502178], [139.347978, 35.50414]]], 'type': 'Polygon'}, 'type': 'Feature'}, {'properties': {'fill-opacity': 0.33, 'fillColor': '#bfaa40', 'opacity': 0.33, 'fill': '#bfaa40', 'fillOpacity': 0.33, 'color': '#bfaa40', 'contour': 20, 'metric': 'time'}, 'geometry': {'coordinates': [[[139.338978, 35.499385], [139.33784, 35.498962], [139.336978, 35.500074], [139.336125, 35.499954], [139.335148, 35.4961], [139.335097, 35.493982], [139.331153, 35.492925], [139.329978, 35.491507], [139.328978, 35.491472], [139.325978, 35.48989], [139.325552, 35.4891], [139.325588, 35.4871], [139.326203, 35.4861], [139.325681, 35.4841], [139.326417, 35.4831], [139.327719, 35.482842], [139.328347, 35.4801], [139.329574, 35.478696], [139.330978, 35.478535], [139.331978, 35.477352], [139.333079, 35.478201], [139.334453, 35.475575], [139.335541, 35.474663], [139.337628, 35.47375], [139.338968, 35.47209], [139.339978, 35.471506], [139.341965, 35.471113], [139.343978, 35.472489], [139.345978, 35.472541], [139.346978, 35.47302], [139.35014, 35.476939], [139.350886, 35.477193], [139.351481, 35.478597], [139.355319, 35.481759], [139.355932, 35.483146], [139.355716, 35.4841], [139.354396, 35.485518], [139.351685, 35.485807], [139.34996, 35.488082], [139.349767, 35.4911], [139.348589, 35.493711], [139.345817, 35.4951], [139.34627, 35.4961], [139.345661, 35.497418], [139.346439, 35.4981], [139.344978, 35.498454], [139.344201, 35.497877], [139.341978, 35.497923], [139.341447, 35.498569], [139.338978, 35.499385]]], 'type': 'Polygon'}, 'type': 'Feature'}, {'properties': {'fill-opacity': 0.33, 'fillColor': '#6abf40', 'opacity': 0.33, 'fill': '#6abf40', 'fillOpacity': 0.33, 'color': '#6abf40', 'contour': 10, 'metric': 'time'}, 'geometry': {'coordinates': [[[139.340978, 35.492218], [139.339978, 35.493039], [139.33868, 35.492399], [139.336218, 35.489861], [139.334978, 35.489074], [139.333742, 35.4891], [139.332835, 35.4871], [139.333978, 35.485492], [139.334553, 35.486525], [139.335266, 35.486388], [139.335154, 35.4841], [139.334312, 35.4831], [139.335266, 35.4811], [139.33701, 35.479132], [139.337752, 35.478874], [139.340978, 35.479034], [139.343978, 35.480491], [139.345412, 35.482666], [139.345794, 35.484284], [139.346978, 35.484042], [139.347664, 35.4851], [139.346593, 35.4861], [139.346447, 35.4891], [139.345197, 35.490319], [139.342976, 35.491103], [139.342105, 35.488973], [139.340885, 35.489007], [139.340798, 35.490281], [139.341517, 35.4911], [139.340978, 35.492218]]], 'type': 'Polygon'}, 'type': 'Feature'}], 'type': 'FeatureCollection'}

    # 国土地理院タイルを用いて、神工大を中心とした地図を生成
    folium_map = folium.Map(
        location=KAIT_GEO.folium_coordinate(),
        zoom_start=13,
        tiles="https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
        attr="出典: 国土地理院ウェブサイト・地理院タイル・標準地図"
    )
    # 徒歩10,20,30分のポリゴンを地図に描画
    for feature in isochrone_geojson["features"]:
        folium.GeoJson(
            feature["geometry"],
            style_function=lambda x: feature["properties"]
        ).add_to(folium_map)
    # 地図保存
    folium_map.save('kait_area.html')


if __name__ == "__main__":
    main()
